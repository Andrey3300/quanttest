# Инструкции по развертыванию изменений

## Быстрый старт

### 1. Установка зависимостей (если еще не установлены)

```bash
cd /workspace
npm install
```

### 2. Запуск сервера

```bash
npm start
```

Или для разработки:

```bash
node backend/server.js
```

### 3. Открыть приложение

Откройте браузер и перейдите на:
```
http://localhost:3001
```

---

## Проверка изменений

### 1. Проверка новых свечей (НЕ плоские)

1. Войдите в приложение
2. Откройте DevTools (F12) и перейдите на вкладку Console
3. Дождитесь создания новой свечи (происходит каждые 5 секунд)
4. Проверьте, что в консоли логируются свечи с разными OHLC значениями

**Ожидаемый результат:**
```
New candle created: 1729577400 open: 18.9234 close: 18.9156
```

### 2. Проверка точности для UAH_USD_OTC

1. В выпадающем меню активов найдите "UAH/USD OTC"
2. Выберите его
3. Проверьте, что цены отображаются с 1-2 знаками после запятой

**Ожидаемый результат:**
```
68623.2  (а не 68623.228200)
```

### 3. Проверка переиспользования WebSocket

1. Откройте DevTools → Network → WS (WebSockets)
2. Переключайтесь между разными активами
3. Убедитесь, что создается ОДНО WebSocket соединение
4. В консоли должны быть сообщения:

**Ожидаемый результат:**
```
Reusing existing connection for symbol change
Client explicitly unsubscribed from USD_MXN_OTC
Client subscribed to BTC_OTC
```

### 4. Проверка очистки неактивных генераторов

1. Запустите сервер
2. Подключитесь к нескольким активам (переключайтесь между ними)
3. Оставьте только один актив открытым
4. Подождите 5 минут
5. Проверьте логи сервера

**Ожидаемый результат:**
```
Cleaned up inactive generator for BTC_OTC
Cleaned up inactive generator for ETH_OTC
Inactive generators cleaned: 2 symbols
```

---

## Список изменений

### Backend (chartGenerator.js)
- ✅ Новые свечи создаются с вариацией сразу (не плоские)
- ✅ Точность 1-2 знака для цен > 10000
- ✅ Пропорциональная волатильность для больших чисел
- ✅ Ослабленный mean reversion для криптовалют (0.002-0.003)

### Frontend (chart.js)
- ✅ Переиспользование одного WebSocket соединения
- ✅ Явный unsubscribe перед subscribe на новый символ

### Backend (server.js)
- ✅ Обработка unsubscribe сообщений
- ✅ Автоматическая очистка неактивных генераторов каждые 5 минут

---

## Устранение неполадок

### Проблема: Свечи все еще плоские

**Решение:**
1. Перезапустите сервер
2. Очистите кэш браузера (Ctrl+Shift+R)
3. Проверьте, что изменения применились в `backend/chartGenerator.js` строка ~178-180

### Проблема: WebSocket создается несколько раз

**Решение:**
1. Проверьте консоль браузера на ошибки
2. Убедитесь, что изменения применились в `frontend/chart.js`
3. Попробуйте жесткую перезагрузку (Ctrl+Shift+R)

### Проблема: Генераторы не очищаются

**Решение:**
1. Проверьте логи сервера через 5 минут после переключения символов
2. Убедитесь, что `generators` экспортируется в `chartGenerator.js`
3. Проверьте, что интервал очистки работает в `server.js`

---

## Дополнительная информация

Подробное описание всех изменений см. в файле:
```
CANDLE_AND_WEBSOCKET_IMPROVEMENTS.md
```

---

## Контакты

При возникновении проблем проверьте:
1. Логи сервера (`console.log` в терминале)
2. Логи браузера (DevTools → Console)
3. WebSocket соединения (DevTools → Network → WS)
4. Файл с улучшениями: `CANDLE_AND_WEBSOCKET_IMPROVEMENTS.md`
