# Changelog - Улучшения графика свечей

## Изменения от 2025-10-21

### Основные улучшения

#### 1. Плавное обновление свечей
- **До**: Свечи обновлялись резко каждые 5 секунд, график "ломался" при взаимодействии
- **После**: 
  - Плавные обновления каждые 150ms (тики)
  - Новая свеча создаётся каждые 5 секунд
  - Реалистичное движение цены как на бинарных платформах (Quotex, Pocket Option, Binomo)

#### 2. Оптимизация производительности
- **Throttling обновлений**: Минимум 50ms между обновлениями UI
- **Защита от перерисовки**: График не перерисовывается при масштабировании/прокрутке
- **Debouncing resize**: Задержка 100ms при изменении размера окна
- **Отслеживание взаимодействия**: Обновления не мешают пользовательским действиям

#### 3. Архитектурные изменения

##### Backend (`backend/chartGenerator.js`)
- Добавлен метод `generateCandleTick()` для плавных промежуточных обновлений
- Реализована интерполяция цен между тиками
- Управление состоянием текущей свечи с целевыми значениями
- Микро-волатильность (30% от основной) для плавности движения

##### Backend (`backend/server.js`)
- Два интервала WebSocket:
  - **150ms**: Отправка тиков (плавные обновления текущей свечи)
  - **5000ms**: Создание новой свечи
- Типы сообщений WebSocket:
  - `tick`: Обновление текущей свечи
  - `newCandle`: Создание новой свечи

##### Frontend (`frontend/chart.js`)
- Улучшенная обработка WebSocket сообщений
- Throttling обновлений (50ms)
- Отслеживание взаимодействия пользователя (mousedown, touchstart, wheel)
- Debounced resize handler
- Защита от перерисовки при масштабировании

### Технические детали

#### Алгоритм плавного обновления
```javascript
// Генерация тика с малой волатильностью
microVolatility = baseVolatility * 0.3
priceChange = randomNormal(0, microVolatility)
newClose = currentClose * (1 + priceChange)

// Обновление high/low с учётом реалистичности
if (close > high) high = close
if (close < low) low = close
```

#### Настройки временных интервалов
- **Tick interval**: 150ms (6-7 обновлений в секунду)
- **Candle interval**: 5000ms (новая свеча каждые 5 секунд)
- **UI throttle**: 50ms (максимум 20 обновлений в секунду)
- **Resize debounce**: 100ms

### Преимущества

1. ✅ **Реалистичность**: График ведёт себя как на профессиональных бинарных платформах
2. ✅ **Стабильность**: Нет "поломки" при масштабировании и прокрутке
3. ✅ **Производительность**: Оптимизированные обновления, низкая нагрузка на CPU
4. ✅ **UX**: Плавное движение цены, приятное визуальное восприятие
5. ✅ **Универсальность**: Работает для всех активов (валюты, крипто, товары)

### Тестирование

Для тестирования:
1. Запустить сервер: `npm start`
2. Открыть фронтенд в браузере
3. Проверить:
   - Плавное движение последней свечи
   - Создание новой свечи каждые 5 секунд
   - Стабильность при масштабировании (Ctrl + scroll)
   - Стабильность при прокрутке (drag & scroll)
   - Переключение между активами

### Совместимость

Изменения обратно совместимы:
- Старые WebSocket сообщения типа `candle` всё ещё поддерживаются
- API endpoints не изменились
- Структура данных свечей осталась прежней

### Будущие улучшения

Возможные дополнительные улучшения:
- [ ] Добавить анимацию при создании новой свечи
- [ ] Настраиваемые интервалы свечей (1s, 5s, 15s, 30s, 1m)
- [ ] Индикаторы и инструменты рисования
- [ ] Сохранение позиции прокрутки при переключении активов
- [ ] Тепловая карта волатильности
